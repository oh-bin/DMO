<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>바이탈 브레스 디지바이스 V 계산기</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1020;
      color: white;
      padding: 20px;
    }
    h1 { color: #7ddcff; }
    button {
      padding: 10px 16px;
      font-size: 15px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 6px 0;
    }
    select {
      padding: 6px;
      border-radius: 6px;
      margin: 4px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #0f172a;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #1e293b;
      padding: 8px;
      text-align: center;
    }
    th { background: #1e293b; }
    .info { margin-top: 20px; color: #94a3b8; font-size: 14px; }
  </style>
</head>
<body>

<h1>바이탈 브레스 디지바이스 V 옵션 계산기</h1>

<button onclick="rollOptions()">옵션 뽑기</button>

<table>
  <thead>
    <tr>
      <th>슬롯</th>
      <th>옵션</th>
      <th>잠금</th>
    </tr>
  </thead>
  <tbody id="optionTable"></tbody>
</table>

<hr style="margin:20px 0;">

<h3>원하는 옵션</h3>
<select id="targetOption"></select>

<br>
<button onclick="calculate()">기대값 계산</button>

<table>
  <thead>
    <tr><th>항목</th><th>값</th></tr>
  </thead>
  <tbody id="calcResult"></tbody>
</table>

<div class="info">
  * 옵션은 동일 확률<br>
  * 잠금 최대 2개 가능<br>
  * 스톤 소모량: 0잠금=1 / 1잠금=3 / 2잠금=5
</div>

<script>
const OPTION_LIMITS = {
  "공격력": 2, "방어력": 2, "최대체력": 2, "디지소울": 2,
  "스킬피해": 2, "크리티컬": 2, "치명피해": 2, "회피": 2, "적중도": 2,
  "방어력%": 1, "최대 DS 증가%": 1, "최대 HP 증가%": 1,
  "스킬 데미지 증가%": 1, "최종 데미지 증가%": 1
};

const OPTION_LIST = Object.keys(OPTION_LIMITS);

let currentOptions = ["", "", "", "", ""];

function initSelect() {
  const sel = document.getElementById("targetOption");
  sel.innerHTML = "";
  OPTION_LIST.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt;
    o.innerText = opt;
    sel.appendChild(o);
  });
}

function buildPool(exclude) {
  const pool = [];
  const used = {};
  exclude.forEach(e => used[e] = (used[e] || 0) + 1);

  for (const [name, limit] of Object.entries(OPTION_LIMITS)) {
    const remain = limit - (used[name] || 0);
    for (let i = 0; i < remain; i++) pool.push(name);
  }
  return pool;
}

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function rollOptions() {
  const checks = document.querySelectorAll("#optionTable input[type=checkbox]");

  let lockedValues = [];
  let lockedSlots = [];

  checks.forEach((c, idx) => {
    if (c.checked && currentOptions[idx]) {
      lockedSlots.push(idx);
      lockedValues.push(currentOptions[idx]);
    }
  });

  let pool = shuffle(buildPool(lockedValues));

  for (let i = 0; i < 5; i++) {
    if (lockedSlots.includes(i)) continue;
    currentOptions[i] = pool.length ? pool.shift() : "";
  }

  renderTable();
}

function renderTable() {
  const tbody = document.getElementById("optionTable");
  tbody.innerHTML = "";

  for (let i = 0; i < 5; i++) {
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.innerText = `${i + 1}번`;

    const td2 = document.createElement("td");
    td2.innerText = currentOptions[i] || "-";

    const td3 = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.onchange = lockLimiter;
    td3.appendChild(cb);

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);

    tbody.appendChild(tr);
  }
}

function lockLimiter() {
  const checks = document.querySelectorAll("#optionTable input[type=checkbox]");
  let count = 0;
  checks.forEach(c => c.checked && count++);

  if (count > 2) {
    this.checked = false;
    alert("최대 2개까지만 잠글 수 있습니다.");
  }
}

function calculate() {
  const target = document.getElementById("targetOption").value;
  const checks = document.querySelectorAll("#optionTable input[type=checkbox]");

  let locked = [];
  let lockCount = 0;
  let lockedSlots = 0;

  checks.forEach((c, i) => {
    if (c.checked && currentOptions[i]) {
      locked.push(currentOptions[i]);
      lockCount++;
      lockedSlots++;
    }
  });

  const pool = buildPool(locked);
  const total = pool.length;

  const targetCount = pool.filter(x => x === target).length;
  const singleProb = total === 0 ? 0 : targetCount / total;

  // 남은 슬롯 수
  const remainSlots = 5 - lockCount;

  // 전체 성공 확률 (모든 남은 슬롯이 전부 원하는 옵션일 확률)
  const fullProb = Math.pow(singleProb, remainSlots);

  let stoneCost = 1;
  if (lockCount === 1) stoneCost = 3;
  if (lockCount === 2) stoneCost = 5;

  const expectedTry = fullProb === 0 ? Infinity : 1 / fullProb;
  const expectedStone = expectedTry * stoneCost;

  const tbody = document.getElementById("calcResult");
  tbody.innerHTML = `
    <tr><td>잠금 수</td><td>${lockCount}개</td></tr>
    <tr><td>총 남은 옵션 수</td><td>${total}개</td></tr>
    <tr><td>원하는 옵션 풀 개수</td><td>${targetCount}개</td></tr>
    <tr><td>한 줄 확률</td><td>${(singleProb * 100).toFixed(4)}%</td></tr>
    <tr><td>전체 성공 확률 (5옵션 기준)</td><td>${(fullProb * 100).toFixed(6)}%</td></tr>
    <tr><td>1회 스톤 소모</td><td>${stoneCost}개</td></tr>
    <tr><td>기대 시도 횟수</td><td>${isFinite(expectedTry) ? expectedTry.toFixed(2) : '불가능'}</td></tr>
    <tr><td>기대 옵션 변경 스톤</td><td>${isFinite(expectedStone) ? expectedStone.toFixed(2) : '불가능'}</td></tr>
  `;
}

initSelect();
rollOptions();
</script>

</body>
</html>
