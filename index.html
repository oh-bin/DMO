<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>디지몬 마스터즈 장비 강화 기대값 계산기</title>
<style>
  body { font-family: sans-serif; background:#f7f7f7; padding:20px; }
  .container { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
  .grid { display:grid; grid-template-columns: 1fr; gap:16px; margin-bottom:20px; }
  .item-card { border:1px solid #ddd; border-radius:12px; padding:10px; text-align:center; }
  .item-card img { width:150px; height:150px; object-fit:contain; border:1px dashed #ccc; border-radius:8px; }
  select { width:100%; box-sizing:border-box; padding:5px; }
  .btn { margin-top:20px; padding:12px 20px; border:none; background:#2d7ff9; color:#fff; border-radius:10px; cursor:pointer; font-size:16px; }
  .result { margin-top:20px; padding:15px; background:#f1f8ff; border-radius:10px; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#f0f0f0; }
</style>
</head>
<body>
<div class="container">
  <h1>디지몬 마스터즈 장비 강화 기대값 계산기</h1>

  <h3>장비 선택</h3>
  <div>
    <label for="equipSelect">장비 부위:</label>
    <select id="equipSelect">
      <option value="머리">머리</option>
      <option value="가방">가방</option>
      <option value="상의">상의</option>
      <option value="하의">하의</option>
      <option value="신발">신발</option>
      <option value="장갑">장갑</option>
      <option value="고스트키링">고스트 키링</option>
    </select>
  </div>

  <div class="grid">
    <div class="item-card">
      <div>장비 그림</div>
      <img id="equip-img" src="" alt="장비 이미지">
    </div>
  </div>

  <h3>강화 단계 설정</h3>
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <div>
      <label for="startLvl">시작 단계:</label>
      <select id="startLvl"></select>
    </div>
    <div>
      <label for="targetLvl">목표 단계:</label>
      <select id="targetLvl"></select>
    </div>
    <div style="display:flex; align-items:center; gap:5px;">
      <input type="checkbox" id="extraMat">
      <label for="extraMat">강화 해킹 툴 사용</label>
    </div>
  </div>

  <div style="margin-bottom:20px;">
    <strong>※ 강화 백업 칩 사용 필수:</strong> 파괴를 방지해줍니다.
  </div>

  <button class="btn" onclick="calculate()">기대값 계산</button>

  <div class="result" id="result"></div>

  <h3>강화 단계 설명</h3>
  <table id="infoTable">
    <thead>
      <tr>
        <th>단계</th>
        <th>성공 확률</th>
        <th>실패 확률</th>
        <th>강화 해킹 툴 사용 시 성공 확률</th>
        <th>강화 해킹 툴 사용 시 실패 확률</th>
        <th>파괴 확률</th>
        <th>단계별 강화 비용</th>
        <th>단계별 필요 재료</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // ===== 이미지 매핑 =====
  const equipImages = {
    "머리": "IMG/head.png",
    "가방": "IMG/bag.png",
    "상의": "IMG/top.png",
    "하의": "IMG/pants.png",
    "신발": "IMG/shoes.png",
    "장갑": "IMG/gloves.png",
    "고스트키링": "IMG/ghostkeyring.png"
  };
  const equipSelect = document.getElementById("equipSelect");
  const equipImg = document.getElementById("equip-img");
  equipSelect.addEventListener("change", () => {
    equipImg.src = equipImages[equipSelect.value] || "";
    renderInfoTable();
  });
  equipImg.src = equipImages[equipSelect.value];

  // ===== 강화 확률 하드코딩 =====
  const baseSuccess = [1.0,1.0,0.9,0.85,0.7,0.55,0.4,0.3,0.2,0.12,0.09,0.07,0.05,0.03,0.02];
  const extraSuccess= [1.0,1.0,0.99,0.935,0.77,0.605,0.44,0.33,0.22,0.132,0.099,0.077,0.055,0.033,0.022];
  const breakRates = [0,0,0,0,0.05,0.1,0.1,0.1,0.1,0.3,0.41,0.47,0.6,0.67,0.78];

  // ===== 장비별 강화 비용 =====
  const defaultCosts = [
    {bit:5500000}, {bit:6050000}, {bit:6655000}, {bit:7320500}, {bit:8784600},
    {bit:10541520}, {bit:12649820}, {bit:15179790}, {bit:18215750}, {bit:23680470},
    {bit:30784610}, {bit:40020000}, {bit:56027990}, {bit:78439190}, {bit:117658800}
  ];

  const ghostKeyringCosts = [
    {bit:10000000, material:"나이프1"}, {bit:11000000, material:"나이프1"}, {bit:12100000, material:"나이프1"},
    {bit:13310000, material:"나이프1"}, {bit:15972000, material:"나이프2"}, {bit:19166400, material:"나이프2"},
    {bit:22999680, material:"나이프2"}, {bit:27599620, material:"나이프2"}, {bit:33119540, material:"나이프2"},
    {bit:43055400, material:"나이프3"}, {bit:50000000, material:"나이프3"}, {bit:55000000, material:"나이프3"},
    {bit:60000000, material:"나이프3"}, {bit:70000000, material:"나이프4"}, {bit:80000000, material:"나이프4"},
    {bit:90000000, material:"나이프4"}
  ];

  // ===== 단계 선택 =====
  const startSelect = document.getElementById('startLvl');
  const targetSelect = document.getElementById('targetLvl');
  for (let i=0;i<=15;i++){
    const opt1 = document.createElement('option'); opt1.value=i; opt1.text=i; startSelect.add(opt1);
    const opt2 = document.createElement('option'); opt2.value=i; opt2.text=i; targetSelect.add(opt2);
  }

  // ===== 비용 단위 변환 함수 =====
  function formatCost(bit){
    let m = Math.floor(bit / 1000);
    let b = bit % 1000;
    let t = Math.floor(m / 1000);
    m = m % 1000;
    return `${t ? t + 'T ' : ''}${m ? m + 'M ' : ''}${b ? b + 'Bit' : ''}`.trim();
  }

  // ===== 강화 단계 설명 테이블 렌더링 =====
  function renderInfoTable(){
    const tbody = document.querySelector("#infoTable tbody");
    tbody.innerHTML = "";
    const equip = equipSelect.value;
    const costs = (equip==="고스트키링") ? ghostKeyringCosts : defaultCosts;

    for(let i=0;i<15;i++){
      const failBase = (1 - baseSuccess[i] - breakRates[i])*100;
      const failExtra = (1 - extraSuccess[i] - breakRates[i])*100;
      const materialStr = costs[i].material || "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i} → ${i+1}</td>
        <td>${(baseSuccess[i]*100).toFixed(1)}%</td>
        <td>${failBase.toFixed(1)}%</td>
        <td>${(extraSuccess[i]*100).toFixed(1)}%</td>
        <td>${failExtra.toFixed(1)}%</td>
        <td>${(breakRates[i]*100).toFixed(1)}%</td>
        <td>${formatCost(costs[i].bit)}</td>
        <td>${materialStr}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  renderInfoTable();

  // ===== 기대값 계산 =====
  function calculate(){
    const start = parseInt(startSelect.value);
    const target = parseInt(targetSelect.value);
    const useExtra = document.getElementById('extraMat').checked;
    const equip = equipSelect.value;
    const costs = (equip==="고스트키링") ? ghostKeyringCosts : defaultCosts;

    if(target <= start){
      alert("목표 단계는 시작 단계보다 커야 합니다.");
      return;
    }

    let totalCostBit = 0;
    let totalMaterials = {};

    for(let i=start;i<target;i++){
      const cost = costs[i].bit;
      const pSuccess = useExtra ? extraSuccess[i] : baseSuccess[i];
      const expectedTries = 1 / pSuccess;
      totalCostBit += expectedTries * cost;

      // 고스트키링 재료 계산
      if(costs[i].material){
        const match = costs[i].material.match(/나이프(\d+)/);
        if(match){
          const count = parseInt(match[1]);
          totalMaterials["나이프"] = (totalMaterials["나이프"] || 0) + expectedTries * count;
        }
      }
    }

    let materialStr = Object.entries(totalMaterials)
      .map(([k,v]) => `${k} x${v.toFixed(2)}`)
      .join(", ");

    document.getElementById('result').innerHTML = `
      <h3>계산 결과</h3>
      <p>총 예상 비용: <b>${formatCost(Math.round(totalCostBit))}</b></p>
      ${materialStr ? `<p>총 필요 재료: <b>${materialStr}</b></p>` : ""}
    `;
  }
</script>
</body>
</html>
